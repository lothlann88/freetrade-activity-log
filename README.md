# Freetrade Activity Log → Holdings

This repository stores a single Freetrade activity export and deterministically derives a current holdings table for analysis and AI workflows. It now also archives the input activity file after processing so `data/` is ready for the next upload.

See the companion specification in [`schema.md`](./schema.md).

## What is in the repo

1. `data/activity.csv` or a single `data/activity-feed-export_*.csv`  
   The canonical Freetrade export. Keep exactly one file at a time in `data/`.

2. `data/holdings.csv`  
   Generated positions table. Do not edit this file by hand.

3. `data/archive/`  
   Timestamped copies of previously processed activity files. The workflow moves the input here after each successful run.

4. `scripts/build_holdings.py`  
   Deterministic transformer from activity to holdings using pooled average cost.

5. `.github/workflows/build-holdings.yml`  
   GitHub Actions workflow that regenerates `data/holdings.csv`, then archives the input.

## Current workflow

1. Trigger  
   The workflow starts on any push that adds or updates `data/activity.csv` or `data/activity-feed-export_*.csv`. You can also run it manually.

2. Build  
   The action runs `scripts/build_holdings.py` to create or refresh `data/holdings.csv`.

3. Archive  
   The action moves the processed activity file into `data/archive/` with a UTC timestamped name, then commits both the updated holdings and the archived file.

4. Permissions  
   The workflow requires repository permission for contents write in two places.  
   • Repository Settings → Actions → General → Workflow permissions: Read and write  
   • In the workflow file:  
     ```
     permissions:
       contents: write
     ```

## Quick start

1. Upload your latest export to `data/`  
   Preferred filename is `data/activity.csv`. A single `data/activity-feed-export_*.csv` also works.

2. Push to `main` or run the workflow manually  
   Actions → Build holdings → Run workflow → Branch main.

3. Review results  
   • `data/holdings.csv` updated  
   • `data/` has no activity file  
   • `data/archive/` contains the timestamped copy of your upload

## How to run manually

1. Open the Actions tab  
2. Select “Build holdings”  
3. Choose “Run workflow” on branch main  
4. Open the run to watch logs and confirm archiving

## Methodology used for holdings

1. UK pooled average cost.  
2. Only rows with `Type = ORDER` and `Buy / Sell ∈ {BUY, SELL}` affect positions.  
3. Fees and taxes are included in cost basis.  
4. Averages are reported in instrument currency and in GBP.  
5. Pools are keyed by `(Ticker, Instrument Currency)` so currencies are not mixed.

The precise field-by-field logic is documented in [`schema.md`](./schema.md).

## Troubleshooting

1. Workflow did not start  
   • Confirm file path is exactly `data/activity.csv` or a single `data/activity-feed-export_*.csv`.  
   • Confirm you pushed to the branch you are watching.  
   • Confirm Actions are enabled and the workflow exists on that branch.

2. Push failed from the runner  
   • Ensure repository Workflow permissions are Read and write.  
   • Ensure the YAML has `permissions: contents: write`.

3. Archiving did not happen  
   • Open the latest run and check the “Archive input CSV(s)” step.  
   • The log should show a line “Archiving data/activity.csv → data/archive/YYYYMMDD_HHMMSS__activity.csv”.  
   • The commit step must stage deletions. The workflow uses `add_options: --all`.

## Typical downstream usage

1. Read `data/holdings.csv`.  
2. Fetch a single pricing source.  
3. Compute value and gain for each line.  
4. Produce suggestions with a pricing disclaimer and timestamp.
